<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>××¢×‘×“×ª ×”××ª××˜×™×§×” / Math Lab</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" type="image/png" href="favicon.png">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin:0; padding:0; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell','Fira Sans','Droid Sans','Helvetica Neue',sans-serif; }
        @keyframes fly-emoji {
            0%   { transform:translate(-50%,-50%) rotate(var(--angle)) translateX(0px);   opacity:1; font-size:1.8rem; }
            60%  { opacity:1; }
            100% { transform:translate(-50%,-50%) rotate(var(--angle)) translateX(320px); opacity:0; font-size:3rem; }
        }
        @keyframes celebration-bg-fade { 0%{opacity:1} 70%{opacity:1} 100%{opacity:0;pointer-events:none} }
        @keyframes correct-bounce { 0%,100%{transform:scale(1)} 30%{transform:scale(1.25) rotate(-3deg)} 60%{transform:scale(1.15) rotate(3deg)} }
        @keyframes wrong-shake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-10px)} 40%{transform:translateX(10px)} 60%{transform:translateX(-7px)} 80%{transform:translateX(7px)} }
        @keyframes score-pop { 0%{transform:scale(1)} 50%{transform:scale(1.4)} 100%{transform:scale(1)} }
        .correct-bounce{animation:correct-bounce 0.6s ease}
        .wrong-shake{animation:wrong-shake 0.5s ease}
        .score-pop{animation:score-pop 0.4s ease}
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
    const { useState, useEffect } = React;

    const Minus = ({size=24,className=''}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
            <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
    );
    const Plus = ({size=24,className=''}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
    );

    const G1 = {bg:'#fed7aa',border:'#f97316',text:'#c2410c'};
    const G2 = {bg:'#bfdbfe',border:'#3b82f6',text:'#1d4ed8'};

    const OBJECT_NAMES = {
            // Original
            apple:{he:'×ª×¤×•×—×™×',en:'apples',emoji:'ğŸ'},
            orange:{he:'×ª×¤×•×–×™×',en:'oranges',emoji:'ğŸŠ'},
            banana:{he:'×‘× × ×•×ª',en:'bananas',emoji:'ğŸŒ'},
            strawberry:{he:'×ª×•×ª×™×',en:'strawberries',emoji:'ğŸ“'},
            ball:{he:'×›×“×•×¨×™×',en:'balls',emoji:'âš½'},
            butterfly:{he:'×¤×¨×¤×¨×™×',en:'butterflies',emoji:'ğŸ¦‹'},
            unicorn:{he:'×—×“×™ ×§×¨×Ÿ',en:'unicorns',emoji:'ğŸ¦„'},
            mouse:{he:'×¢×›×‘×¨×™×',en:'mice',emoji:'ğŸ­'},
            dress:{he:'×©××œ×•×ª',en:'dresses',emoji:'ğŸ‘—'},
            shoe:{he:'× ×¢×œ×™×™×',en:'shoes',emoji:'ğŸ‘ '},
            cookie:{he:'×¢×•×’×™×•×ª',en:'cookies',emoji:'ğŸª'},
            star:{he:'×›×•×›×‘×™×',en:'stars',emoji:'â­'},
            shirt:{he:'×—×•×œ×¦×•×ª',en:'shirts',emoji:'ğŸ‘•'},
            // Additional foods
            pizza:{he:'×¤×™×¦×•×ª',en:'pizzas',emoji:'ğŸ•'},
            watermelon:{he:'××‘×˜×™×—×™×',en:'watermelons',emoji:'ğŸ‰'},
            grapes:{he:'×¢× ×‘×™×',en:'grapes',emoji:'ğŸ‡'},
            carrot:{he:'×’×–×¨×™×',en:'carrots',emoji:'ğŸ¥•'},
            corn:{he:'×ª×™×¨×¡×™×',en:'corns',emoji:'ğŸŒ½'},
            taco:{he:'×˜××§×•',en:'tacos',emoji:'ğŸŒ®'},
            icecream:{he:'×’×œ×™×“×•×ª',en:'ice creams',emoji:'ğŸ¦'},
            donut:{he:'×“×•× ××˜×¡',en:'donuts',emoji:'ğŸ©'},
            cake:{he:'×¢×•×’×•×ª',en:'cakes',emoji:'ğŸ‚'},
            lemon:{he:'×œ×™××•× ×™×',en:'lemons',emoji:'ğŸ‹'},
            // Instruments
            guitar:{he:'×’×™×˜×¨×•×ª',en:'guitars',emoji:'ğŸ¸'},
            piano:{he:'×¤×¡× ×ª×¨×™×',en:'pianos',emoji:'ğŸ¹'},
            trumpet:{he:'×—×¦×•×¦×¨×•×ª',en:'trumpets',emoji:'ğŸº'},
            violin:{he:'×›×™× ×•×¨×•×ª',en:'violins',emoji:'ğŸ»'},
            drum:{he:'×ª×•×¤×™×',en:'drums',emoji:'ğŸ¥'},
            // Travel & Places
            airplane:{he:'××˜×•×¡×™×',en:'airplanes',emoji:'âœˆï¸'},
            car:{he:'××›×•× ×™×•×ª',en:'cars',emoji:'ğŸš—'},
            train:{he:'×¨×›×‘×•×ª',en:'trains',emoji:'ğŸš‚'},
            rocket:{he:'×¨×§×˜×•×ª',en:'rockets',emoji:'ğŸš€'},
            boat:{he:'×¡×™×¨×•×ª',en:'boats',emoji:'â›µ'},
            bicycle:{he:'××•×¤× ×™×™×',en:'bicycles',emoji:'ğŸš²'},
            globe:{he:'×’×œ×•×‘×•×¡×™×',en:'globes',emoji:'ğŸŒ'},
            compass:{he:'××¦×¤× ×™×',en:'compasses',emoji:'ğŸ§­'},
            tent:{he:'××•×”×œ×™×',en:'tents',emoji:'â›º'},
            luggage:{he:'××–×•×•×“×•×ª',en:'suitcases',emoji:'ğŸ§³'},
            // Hearts
            heart:{he:'×œ×‘×‘×•×ª',en:'hearts',emoji:'â¤ï¸'},
            yellowheart:{he:'×œ×‘×‘×•×ª ×¦×”×•×‘×™×',en:'yellow hearts',emoji:'ğŸ’›'},
            blueheart:{he:'×œ×‘×‘×•×ª ×›×—×•×œ×™×',en:'blue hearts',emoji:'ğŸ’™'},
            greenheart:{he:'×œ×‘×‘×•×ª ×™×¨×•×§×™×',en:'green hearts',emoji:'ğŸ’š'},
            purpleheart:{he:'×œ×‘×‘×•×ª ×¡×’×•×œ×™×',en:'purple hearts',emoji:'ğŸ’œ'},
            // Pencils & stationery
            pencil:{he:'×¢×¤×¨×•× ×•×ª',en:'pencils',emoji:'âœï¸'},
            pen:{he:'×¢×˜×™×',en:'pens',emoji:'ğŸ–Šï¸'},
            crayon:{he:'×¦×‘×¢×™×',en:'crayons',emoji:'ğŸ–ï¸'},
            notebook:{he:'××—×‘×¨×•×ª',en:'notebooks',emoji:'ğŸ““'},
            ruler:{he:'×¡×¨×’×œ×™×',en:'rulers',emoji:'ğŸ“'},
            // Cute animals
            cat:{he:'×—×ª×•×œ×™×',en:'cats',emoji:'ğŸ±'},
            dog:{he:'×›×œ×‘×™×',en:'dogs',emoji:'ğŸ¶'},
            rabbit:{he:'××¨× ×‘×™×',en:'rabbits',emoji:'ğŸ°'},
            bear:{he:'×“×•×‘×™×',en:'bears',emoji:'ğŸ»'},
            panda:{he:'×¤× ×“×•×ª',en:'pandas',emoji:'ğŸ¼'},
            chick:{he:'××¤×¨×•×—×™×',en:'chicks',emoji:'ğŸ¥'},
            penguin:{he:'×¤×™× ×’×•×•×™× ×™×',en:'penguins',emoji:'ğŸ§'},
            frog:{he:'×¦×¤×¨×“×¢×™×',en:'frogs',emoji:'ğŸ¸'},
            hamster:{he:'××•×’×¨×™×',en:'hamsters',emoji:'ğŸ¹'},
            koala:{he:'×§×•××œ×•×ª',en:'koalas',emoji:'ğŸ¨'},
            // Clothing & accessories
            hat:{he:'×›×•×‘×¢×™×',en:'hats',emoji:'ğŸ©'},
            cap:{he:'×›×•×‘×¢×™ ××¦×—×™×™×”',en:'caps',emoji:'ğŸ§¢'},
            scarf:{he:'×¦×¢×™×¤×™×',en:'scarves',emoji:'ğŸ§£'},
            gloves:{he:'×›×¤×¤×•×ª',en:'gloves',emoji:'ğŸ§¤'},
            bow:{he:'×¤×¤×™×•× ×™×',en:'bows',emoji:'ğŸ€'},
            bag:{he:'×ª×™×§×™×',en:'bags',emoji:'ğŸ‘œ'},
            backpack:{he:'×ª×¨××™×œ×™×',en:'backpacks',emoji:'ğŸ’'},
            crown:{he:'×›×ª×¨×™×',en:'crowns',emoji:'ğŸ‘‘'},
            glasses:{he:'××©×§×¤×™×™×',en:'glasses',emoji:'ğŸ‘“'},
            boots:{he:'××’×¤×™×™×',en:'boots',emoji:'ğŸ‘¢'},
    };

    function MathLab() {
        const [startNum,    setStartNum]    = useState(9);
        const [subtractNum, setSubtractNum] = useState(2);
        const [isAddition,  setIsAddition]  = useState(false);
        const [activeTab,   setActiveTab]   = useState('numberline');
        const [userAnswer,  setUserAnswer]  = useState('');
        const [showResult,  setShowResult]  = useState(false);
        const [direction,   setDirection]   = useState('back');

        // Settings
        const [firstNumMin,       setFirstNumMin]       = useState(5);
        const [firstNumMax,       setFirstNumMax]       = useState(13);
        const [subtractMin,       setSubtractMin]       = useState(0);
        const [subtractMax,       setSubtractMax]       = useState(13);
        const [maxAdditionAnswer, setMaxAdditionAnswer] = useState(15);
        const [subtractionPct,    setSubtractionPct]    = useState(70);
        const [randomSeed,        setRandomSeed]        = useState(null);
        const [dotSize,           setDotSize]           = useState('medium');
        const [objectType,        setObjectType]        = useState('apple');
        const [showStepCounter,   setShowStepCounter]   = useState(false);
        const [mustAnswerFirst,   setMustAnswerFirst]   = useState(true);

        // Number line
        const [currentPosition,  setCurrentPosition]  = useState(null);
        const [steps,            setSteps]            = useState(0);
        const [startingPosition, setStartingPosition] = useState(null);

        // Objects tab
        const [appleMode,        setAppleMode]        = useState('delete');
        const [showAppleNumbers, setShowAppleNumbers] = useState(false);
        const [removedApples,    setRemovedApples]    = useState([]);
        const [countedApples,    setCountedApples]    = useState([]);
        const [addedObjects,     setAddedObjects]     = useState([]); // [{id,group}]

        // Fingers
        const [closedFingers,    setClosedFingers]    = useState([]);
        const [fingerMode,       setFingerMode]       = useState('mark');
        const [showFingerNumbers,setShowFingerNumbers]= useState(false);
        const [countedFingers,   setCountedFingers]   = useState([]);

        // Chosen starting addend for Objects & Fingers tabs in addition mode
        const [addStartFromObjects, setAddStartFromObjects] = useState(null); // null | number
        const [addStartFromFingers, setAddStartFromFingers] = useState(null); // null | number

        // Score / celebration
        const [correctCount, setCorrectCount] = useState(0);
        const [wrongCount,   setWrongCount]   = useState(0);
        const [celebration,  setCelebration]  = useState(null);
        const [resultAnimKey,setResultAnimKey]= useState(0);

        const correctAnswer = isAddition ? startNum + subtractNum : startNum - subtractNum;
        const obj = OBJECT_NAMES[objectType];

        // â”€â”€ Celebration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const celebrationThemes = [
            ['ğŸ‰','ğŸŠ','ğŸˆ','ğŸ','ğŸ€'],['â­','ğŸŒŸ','ğŸ’«','âœ¨','ğŸŒ '],
            ['â¤ï¸','ğŸ’•','ğŸ’–','ğŸ’—','ğŸ’'],['ğŸ¦‹','ğŸŒˆ','ğŸŒ¸','ğŸŒº','ğŸŒ»'],
            ['ğŸµ','ğŸ¶','ğŸ¸','ğŸ¹','ğŸº'],['ğŸ­','ğŸ¬','ğŸ«','ğŸ§','ğŸ°'],
        ];
        const triggerCelebration = (emoji) => {
            const base = celebrationThemes[Math.floor(Math.random()*celebrationThemes.length)];
            setCelebration({emojis:[...base,emoji,emoji],key:Date.now()});
            setTimeout(()=>setCelebration(null),2600);
        };

        // â”€â”€ RNG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const seededRandom = (min,max,seed) => {
            const x=Math.sin(seed)*10000; return Math.floor((x-Math.floor(x))*(max-min+1))+min;
        };
        const seededFloat = (seed) => { const x=Math.sin(seed)*10000; return x-Math.floor(x); };
        const triSample = (a,b,c,u) => {
            if(a===b) return a;
            const m=Math.max(a,Math.min(b,c)), fc=(m-a)/(b-a);
            return u<fc ? a+Math.sqrt(u*(b-a)*(m-a)) : b-Math.sqrt((1-u)*(b-a)*(b-m));
        };

        // â”€â”€ Question generation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const generateNewQuestion = () => {
            if(randomSeed===null) return;
            const seed=randomSeed+1; setRandomSeed(seed);
            const doAdd = seededFloat(seed*3)*100 >= subtractionPct;
            setIsAddition(doAdd);
            if(doAdd) {
                const maxAns=Math.max(2,maxAdditionAnswer);
                const sum=Math.max(2,Math.round(triSample(2,maxAns,maxAns,seededFloat(seed))));
                const a1=Math.max(1,Math.min(sum-1,Math.round(triSample(1,Math.max(1,sum-1),(sum-1)/2,seededFloat(seed*2)))));
                setStartNum(a1); setSubtractNum(sum-a1);
            } else {
                const s=seededRandom(firstNumMin,firstNumMax,seed);
                const aMin=Math.max(0,subtractMin), aMax=Math.min(s,subtractMax);
                let sub;
                if(aMin>aMax) sub=Math.min(s,subtractMin);
                else if(aMin===aMax) sub=aMin;
                else sub=Math.round(triSample(aMin,aMax,3*(s/2)-aMin-aMax,seededFloat(seed*2)));
                setStartNum(s); setSubtractNum(sub);
            }
        };

        const resetLab = () => {
            setCurrentPosition(null); setSteps(0); setStartingPosition(null);
            setRemovedApples([]); setCountedApples([]); setAddedObjects([]);
            setClosedFingers([]); setCountedFingers([]);
            setAddStartFromObjects(null);
            setAddStartFromFingers(null);
        };

        // â”€â”€ Persistence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        useEffect(()=>{
            if(randomSeed===null) setRandomSeed(Date.now());
            const saved=localStorage.getItem('mathLabSettings');
            if(saved){try{
                const s=JSON.parse(saved);
                if(s.firstNumMin!==undefined) setFirstNumMin(s.firstNumMin);
                if(s.firstNumMax!==undefined) setFirstNumMax(s.firstNumMax);
                if(s.subtractMin!==undefined) setSubtractMin(s.subtractMin);
                if(s.subtractMax!==undefined) setSubtractMax(s.subtractMax);
                if(s.maxAdditionAnswer!==undefined) setMaxAdditionAnswer(s.maxAdditionAnswer);
                if(s.subtractionPct!==undefined) setSubtractionPct(s.subtractionPct);
                if(s.dotSize!==undefined) setDotSize(s.dotSize);
                if(s.objectType!==undefined) setObjectType(s.objectType);
                if(s.mustAnswerFirst!==undefined) setMustAnswerFirst(s.mustAnswerFirst);
            }catch(e){}}
        },[]);

        useEffect(()=>{
            if(randomSeed!==null && startNum===9 && subtractNum===2) generateNewQuestion();
        },[randomSeed]); // eslint-disable-line

        useEffect(()=>{
            localStorage.setItem('mathLabSettings',JSON.stringify({
                firstNumMin,firstNumMax,subtractMin,subtractMax,
                maxAdditionAnswer,subtractionPct,dotSize,objectType,mustAnswerFirst
            }));
        },[firstNumMin,firstNumMax,subtractMin,subtractMax,maxAdditionAnswer,subtractionPct,dotSize,objectType,mustAnswerFirst]);

        useEffect(()=>{
            resetLab(); setUserAnswer(''); setShowResult(false);
            setAppleMode(isAddition?'add':'delete'); setShowAppleNumbers(false);
            setDirection(isAddition?'up':'back');
            setFingerMode(isAddition?'count':'mark'); setShowFingerNumbers(false);
        },[startNum,subtractNum,isAddition]);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // NUMBER LINE TAB
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const NumberLineTab = () => {
            // Axis long enough for the sum, but no answer marker shown
            const maxNum = Math.max(startNum + subtractNum + 2, 10);
            const started = currentPosition!==null;
            const dotSizes = {small:{main:8,cur:6,path:4},medium:{main:12,cur:10,path:6},large:{main:16,cur:13,path:8}};
            const sz = dotSizes[dotSize];
            const effDir = direction; // user always picks direction themselves

            const step = () => {
                if(effDir==='back'){if(currentPosition>0){setCurrentPosition(currentPosition-1);setSteps(steps+1);}}
                else{if(currentPosition<maxNum){setCurrentPosition(currentPosition+1);setSteps(steps+1);}}
            };
            const handleClick = (num) => {
                if(!started){setStartingPosition(num);setCurrentPosition(num);setSteps(0);}
                else if(num===startingPosition) resetLab();
                else step();
            };

            return (
                <div className="space-y-6">
                    <div className="text-center space-y-3">
                        {!started ? (<>
                            <p className="text-lg">×‘×—×¨ ×›×™×•×•×Ÿ ×•××¡×¤×¨ ×”×ª×—×œ×” / Choose direction and starting number</p>
                            <div className="flex justify-center gap-4 items-center">
                                <button onClick={()=>setDirection('back')} className={`px-6 py-3 rounded-lg text-lg font-semibold ${direction==='back'?'bg-red-500 text-white':'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>â¬…ï¸ ×¦×¢×“ ××—×•×¨×” / Step Back</button>
                                <button onClick={()=>setDirection('up')} className={`px-6 py-3 rounded-lg text-lg font-semibold ${direction==='up'?'bg-green-500 text-white':'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>â¡ï¸ ×¦×¢×“ ×§×“×™××” / Step Up</button>
                            </div>
                        </>) : (
                            <div className="space-y-3">
                                <p className="text-lg">×œ×—×¥ ×¢×œ ×”×¦×™×¨ ×›×“×™ ×œ×¦×¢×•×“ / Click on axis to step</p>
                                <p className="text-sm text-gray-600">×œ×—×¥ ×¢×œ ×”× ×§×•×“×” ×”××“×•××” ×œ××™×¤×•×¡ / Click red dot to reset</p>
                                {showStepCounter && <p className="text-xl font-bold text-green-600">×¦×¢×“×™×: {steps} / Steps: {steps}</p>}
                                <div className="flex justify-center gap-4 flex-wrap items-center">
                                    <button onClick={step} className={`px-8 py-4 rounded-lg text-2xl font-bold ${effDir==='back'?'bg-red-500 text-white hover:bg-red-600':'bg-green-500 text-white hover:bg-green-600'}`}>
                                        {effDir==='back'?'â¬…ï¸ ××—×•×¨×” / Back':'â¡ï¸ ×§×“×™××” / Forward'}
                                    </button>
                                    <button onClick={resetLab} className="px-6 py-4 bg-blue-500 text-white rounded-lg text-xl hover:bg-blue-600">ğŸ”„ ××™×¤×•×¡ / Reset</button>
                                </div>
                                <div className="flex justify-center">
                                    <label className="flex items-center gap-2 text-lg bg-white px-4 py-2 rounded-lg border-2 border-gray-300">
                                        <input type="checkbox" checked={showStepCounter} onChange={e=>setShowStepCounter(e.target.checked)} className="w-5 h-5"/>
                                        <span>×”×¦×’ ×¡×¤×™×¨×ª ×¦×¢×“×™× / Show Step Counter</span>
                                    </label>
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="relative h-32 bg-gray-100 rounded-lg p-4">
                        {!started && (
                            <div className="absolute top-2 left-1/2 transform -translate-x-1/2 text-purple-600 font-semibold text-center">
                                ×œ×—×¥ ×¢×œ ××¡×¤×¨ ×œ×”×ª×—×œ×”<br/>Click a number to start
                            </div>
                        )}
                        <svg className="w-full h-full">
                            <line x1="5%" y1="60%" x2="95%" y2="60%" stroke="#333" strokeWidth="3"/>
                            {started && steps>0 && (
                                <line x1={`${5+(90/maxNum)*Math.min(startingPosition,currentPosition)}%`} y1="60%"
                                      x2={`${5+(90/maxNum)*Math.max(startingPosition,currentPosition)}%`} y2="60%"
                                      stroke="#10b981" strokeWidth="6"/>
                            )}
                            {Array.from({length:maxNum+1},(_,i)=>{
                                const x=5+(90/maxNum)*i;
                                const isStart=started&&i===startingPosition;
                                const isCur=started&&i===currentPosition&&i!==startingPosition;
                                const isPath=started&&steps>0&&(
                                    (effDir==='back'&&i<startingPosition&&i>currentPosition)||
                                    (effDir==='up'&&i>startingPosition&&i<currentPosition)
                                );
                                return (
                                    <g key={i}>
                                        <line x1={`${x}%`} y1="50%" x2={`${x}%`} y2="70%" stroke="#333" strokeWidth="2"/>
                                        <text x={`${x}%`} y="85%" textAnchor="middle" fontSize="12">{i}</text>
                                        <circle cx={`${x}%`} cy="60%" r="15" fill="transparent"
                                            className="cursor-pointer hover:fill-blue-100"
                                            onClick={()=>handleClick(i)}/>
                                        {isStart && <circle cx={`${x}%`} cy="60%" r={sz.main} fill="#ef4444" style={{pointerEvents:'none'}}/>}
                                        {isCur   && <circle cx={`${x}%`} cy="60%" r={sz.cur}  fill="#3b82f6" style={{pointerEvents:'none'}}/>}
                                        {isPath  && <circle cx={`${x}%`} cy="60%" r={sz.path} fill="#10b981" style={{pointerEvents:'none'}}/>}
                                    </g>
                                );
                            })}
                        </svg>
                    </div>
                </div>
            );
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // OBJECTS TAB
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Cycling colors for addition objects â€” one new color per click, no answer hint
        const ADD_COLORS = [
            {bg:'#fed7aa',border:'#f97316'},{bg:'#bfdbfe',border:'#3b82f6'},
            {bg:'#bbf7d0',border:'#22c55e'},{bg:'#fde68a',border:'#eab308'},
            {bg:'#e9d5ff',border:'#a855f7'},{bg:'#fecdd3',border:'#f43f5e'},
            {bg:'#cffafe',border:'#06b6d4'},{bg:'#d1fae5',border:'#10b981'},
        ];

        const ObjectsTab = () => {
            if(isAddition) {
                // â”€â”€ start-from picker â”€â”€
                if(addStartFromObjects === null) {
                    return (
                        <div className="space-y-6 text-center">
                            <p className="text-lg">×”×ª×—×œ ×××™×–×” ××—×‘×¨? / Which addend to start placing?</p>
                            <div className="flex justify-center gap-6 flex-wrap">
                                {[startNum, subtractNum].map((val, idx) => {
                                    const gc = idx===0 ? G1 : G2;
                                    return (
                                        <button key={val+'-'+idx}
                                            onClick={()=>{
                                                const baseColorIdx = idx===0 ? 0 : 1;
                                                const pre = Array.from({length:val},(_,i)=>({id:i,colorIdx:baseColorIdx}));
                                                setAddedObjects(pre);
                                                setAddStartFromObjects(val);
                                                setAppleMode('add');
                                            }}
                                            style={{background:gc.bg,border:`2px solid ${gc.border}`,color:gc.text}}
                                            className="px-8 py-5 rounded-2xl text-3xl font-bold hover:opacity-80 transition-all active:scale-95">
                                            ×”×ª×—×œ ×-{val}<br/>
                                            <span className="text-lg font-normal">Start from {val}</span>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    );
                }

                // â”€â”€ main addition objects UI (after start chosen) â”€â”€
                const nextId = addedObjects.length>0 ? Math.max(...addedObjects.map(o=>o.id))+1 : 0;
                const startColorIdx = addedObjects.length > 0 ? addedObjects[0].colorIdx : 0;
                const nextColorIdx = addedObjects.length < addStartFromObjects ? startColorIdx : (1 - startColorIdx);
                const nextGc = nextColorIdx === 0 ? G1 : G2;

                const addObj=()=>{
                    setAddedObjects([...addedObjects,{id:nextId,colorIdx:nextColorIdx}]);
                };
                const removeObj=(id)=>{
                    setAddedObjects(addedObjects.filter(o=>o.id!==id));
                    setCountedApples(countedApples.filter(i=>i!==id));
                };
                return (
                    <div className="space-y-6">
                        {/* Mode bar â€” clicking Add again adds one object */}
                        <div className="flex justify-center gap-3 items-center flex-wrap">
                            {['add','delete','count'].map(m=>(
                                <button key={m} onClick={()=>{
                                    if(m==='add' && appleMode==='add') { addObj(); return; }
                                    setAppleMode(m); setCountedApples([]);
                                }}
                                    className={`px-5 py-3 rounded-lg text-lg font-semibold ${appleMode===m?(m==='add'?'bg-purple-500':m==='delete'?'bg-red-500':'bg-green-500')+' text-white':'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>
                                    {m==='add'?'â• ×”×•×¡×£ / Add':m==='delete'?'ğŸ—‘ï¸ ××—×§ / Delete':'ğŸ”¢ ×¡×¤×•×¨ / Count'}
                                </button>
                            ))}
                            {appleMode==='count' && (
                                <label className="flex items-center gap-2 text-lg bg-white px-4 py-2 rounded-lg border-2 border-gray-300">
                                    <input type="checkbox" checked={showAppleNumbers} onChange={e=>setShowAppleNumbers(e.target.checked)} className="w-5 h-5"/>
                                    <span>×”×¦×’ ××¡×¤×¨×™× / Show Numbers</span>
                                </label>
                            )}
                        </div>

                        <div className="text-center text-sm text-gray-500">
                            {appleMode==='add'&&`×œ×—×¥ â• ×œ×”×•×¡×™×£ ${obj.emoji} / Click â• to add ${obj.emoji}`}
                            {appleMode==='delete'&&`×œ×—×¥ ×¢×œ ${obj.emoji} ×œ×”×¡×¨×” / Click ${obj.emoji} to remove`}
                            {appleMode==='count'&&`×œ×—×¥ ×¢×œ ${obj.emoji} ×œ×¡×¤×™×¨×” / Click ${obj.emoji} to count`}
                        </div>

                        <div className="bg-green-50 rounded-lg p-6 min-h-48 flex items-center justify-center">
                            {addedObjects.length===0 ? (
                                <p className="text-2xl text-gray-400">×œ×—×¥ â• ×›×“×™ ×œ×”×•×¡×™×£ / Press â• to add</p>
                            ) : (
                                <div className="flex flex-wrap gap-3 justify-center max-w-lg">
                                    {addedObjects.map(o=>{
                                        const gc = o.colorIdx === 0 ? G1 : G2;
                                        const isCounted=appleMode==='count'&&countedApples.includes(o.id);
                                        const countNum=isCounted?countedApples.indexOf(o.id)+1:null;
                                        return (
                                            <button key={o.id}
                                                onClick={()=>{
                                                    if(appleMode==='delete') removeObj(o.id);
                                                    else if(appleMode==='count'){
                                                        if(isCounted) setCountedApples(countedApples.filter(i=>i!==o.id));
                                                        else setCountedApples([...countedApples,o.id]);
                                                    }
                                                }}
                                                style={{background:isCounted?'#dcfce7':gc.bg,border:`2px solid ${gc.border}`}}
                                                className="relative w-16 h-16 rounded-xl flex items-center justify-center text-4xl transition-all hover:opacity-80">
                                                {obj.emoji}
                                                {isCounted&&showAppleNumbers&&(
                                                    <div className="absolute inset-0 flex items-center justify-center">
                                                        <span className="text-xl font-bold text-white drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]">{countNum}</span>
                                                    </div>
                                                )}
                                            </button>
                                        );
                                    })}
                                </div>
                            )}
                        </div>

                        <div className="text-center">
                            <button onClick={resetLab} className="px-6 py-3 bg-blue-500 text-white rounded-lg text-xl hover:bg-blue-600">ğŸ”„ ××™×¤×•×¡ / Reset</button>
                        </div>
                    </div>
                );
            }

            // Subtraction mode
            const apples=Array.from({length:startNum},(_,i)=>i);
            const handleAppleClick=(index)=>{
                if(removedApples.includes(index)){if(appleMode==='delete')setRemovedApples(removedApples.filter(i=>i!==index));return;}
                if(appleMode==='delete'){if(removedApples.length<subtractNum)setRemovedApples([...removedApples,index]);}
                else{if(countedApples.includes(index))setCountedApples(countedApples.filter(i=>i!==index));else setCountedApples([...countedApples,index]);}
            };
            return (
                <div className="space-y-6">
                    <div className="flex justify-center gap-4 items-center flex-wrap">
                        <button onClick={()=>{setAppleMode('delete');setCountedApples([]);}} className={`px-6 py-3 rounded-lg text-lg font-semibold ${appleMode==='delete'?'bg-red-500 text-white':'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>ğŸ—‘ï¸ ××—×§ / Delete</button>
                        <button onClick={()=>{setAppleMode('count');setCountedApples([]);}} className={`px-6 py-3 rounded-lg text-lg font-semibold ${appleMode==='count'?'bg-green-500 text-white':'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>ğŸ”¢ ×¡×¤×•×¨ / Count</button>
                        {appleMode==='count'&&(<label className="flex items-center gap-2 text-lg bg-white px-4 py-2 rounded-lg border-2 border-gray-300"><input type="checkbox" checked={showAppleNumbers} onChange={e=>setShowAppleNumbers(e.target.checked)} className="w-5 h-5"/><span>×”×¦×’ ××¡×¤×¨×™× / Show Numbers</span></label>)}
                    </div>
                    <div className="text-center space-y-2">
                        {appleMode==='delete'?(<><p className="text-lg">×™×© ×œ×š {startNum} {obj.he}, ×”×•×¦× {subtractNum} {obj.he}</p><p className="text-lg">You have {startNum} {obj.en}, remove {subtractNum} {obj.en}</p></>)
                        :(<><p className="text-lg">×¡×¤×•×¨ ××ª ×”{obj.he} ×©× ×©××¨×• / Count the remaining {obj.en}</p></>)}
                        {startNum>0&&<p className="text-sm text-gray-600">×œ×—×¥ ×¢×œ {obj.emoji} / Click {obj.emoji}</p>}
                    </div>
                    <div className="bg-green-50 rounded-lg p-8 min-h-48 flex items-center justify-center">
                        {startNum===0?(<p className="text-2xl text-gray-500">××™×Ÿ {obj.he} / No {obj.en}</p>):(
                            <div className="grid grid-cols-5 gap-4 max-w-md">
                                {apples.map(i=>{
                                    const isRem=removedApples.includes(i), isCnt=appleMode==='count'&&countedApples.includes(i);
                                    return (
                                        <button key={i} onClick={()=>handleAppleClick(i)}
                                            className={`relative transform transition-all text-5xl ${isRem?'opacity-30 scale-75':'opacity-100 scale-100 hover:scale-110'}`}
                                            style={{filter:isCnt?'brightness(1.2) contrast(1.2)':'none'}}>
                                            <span style={{filter:isRem?'grayscale(100%)':'none',display:'inline-block'}}>{obj.emoji}</span>
                                            {isCnt&&showAppleNumbers&&(<div className="absolute inset-0 flex items-center justify-center"><span className="text-2xl font-bold text-white drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]">{countedApples.indexOf(i)+1}</span></div>)}
                                        </button>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                    <div className="text-center"><button onClick={resetLab} className="px-6 py-3 bg-blue-500 text-white rounded-lg text-xl hover:bg-blue-600">ğŸ”„ ××™×¤×•×¡ / Reset</button></div>
                </div>
            );
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FINGERS TAB
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const FingersTab = () => {
            // Number of hands must cover the final answer without revealing it explicitly.
            // For addition: cover startNum+subtractNum. For subtraction: cover startNum.
            // We round up to the nearest full hand (multiples of 5).
            const fingerCapacity = isAddition ? startNum + subtractNum : startNum;
            const numHands = Math.max(1, Math.ceil(fingerCapacity / 5));
            const totalSlots = numHands * 5;

            // raisedFingers: array of slot indices that are "up" (raised)
            // We reuse closedFingers state but invert semantics for addition:
            // For addition: closedFingers = raised finger indices
            // For subtraction: closedFingers = folded/marked finger indices (existing)

            // For addition we track raised fingers separately via addedObjects reuse â€”
            // actually let's just use a dedicated raisedFingers built from closedFingers for addition.
            // Convention: in addition mode, closedFingers = indices that ARE raised (up).
            const raisedFingers = closedFingers; // alias for clarity in addition mode
            const setRaisedFingers = setClosedFingers;

            const raiseNext = () => {
                for(let i=0; i<totalSlots; i++){
                    if(!raisedFingers.includes(i)){
                        setRaisedFingers([...raisedFingers, i]);
                        setCountedFingers([]);
                        return;
                    }
                }
            };
            const lowerLast = () => {
                if(raisedFingers.length === 0) return;
                const sorted = [...raisedFingers].sort((a,b)=>a-b);
                setRaisedFingers(sorted.slice(0,-1));
                setCountedFingers([]);
            };

            // Addition: start from one of the addends
            const startFromAddendFingers = (val, colorGroup) => {
                const indices = Array.from({length: val}, (_, i) => i);
                setRaisedFingers(indices);
                setAddStartFromFingers(val);
            };

            // Subtraction finger click (existing behavior)
            const handleFingerClickSub = (hi, fi) => {
                const gi = hi*5 + fi;
                if(gi >= startNum) return;
                if(fingerMode === 'mark'){
                    if(closedFingers.includes(gi)) setClosedFingers(closedFingers.filter(i=>i!==gi));
                    else if(closedFingers.length < subtractNum) setClosedFingers([...closedFingers, gi]);
                } else {
                    if(countedFingers.includes(gi)) setCountedFingers(countedFingers.filter(i=>i!==gi));
                    else setCountedFingers([...countedFingers, gi]);
                }
            };

            const Hand = ({handIndex, mode}) => {
                const Finger = ({fi}) => {
                    const gi = handIndex*5 + fi;
                    const pos = [{x:5,w:15},{x:23,w:13},{x:39,w:13},{x:55,w:13},{x:71,w:12}][fi];

                    if(mode === 'addition') {
                        const isRaised = raisedFingers.includes(gi);
                        const firstGroupCount = addStartFromFingers !== null ? addStartFromFingers : startNum;
                        const inGroup1 = gi < firstGroupCount;
                        const isCounted = fingerMode==='count' && isRaised && countedFingers.includes(gi);
                        const countNum = isCounted ? countedFingers.indexOf(gi)+1 : null;
                        const fc = isRaised ? (isCounted ? '#10b981' : (inGroup1 ? '#fbbf24' : '#93c5fd')) : '#e5e7eb';
                        const nailFc = isRaised ? (isCounted ? '#dcfce7' : (inGroup1 ? '#fef3c7' : '#dbeafe')) : '#f3f4f6';
                        const handleClick = () => {
                            if(fingerMode === 'count') {
                                // Count mode: toggle count on raised fingers only
                                if(!isRaised) return;
                                if(isCounted) setCountedFingers(countedFingers.filter(i=>i!==gi));
                                else setCountedFingers([...countedFingers, gi]);
                            } else {
                                // Default: toggle raised/lowered
                                if(isRaised) setRaisedFingers(raisedFingers.filter(i=>i!==gi));
                                else setRaisedFingers([...raisedFingers, gi]);
                            }
                        };
                        return (
                            <g onClick={handleClick} className="cursor-pointer" opacity={1}>
                                <path d={`M ${pos.x} 70 L ${pos.x} 45 Q ${pos.x} 42 ${pos.x+pos.w/2} 40 Q ${pos.x+pos.w} 42 ${pos.x+pos.w} 45 L ${pos.x+pos.w} 70 Z`} fill={fc} stroke="#78716c" strokeWidth={1.5}/>
                                <path d={`M ${pos.x+1} 45 L ${pos.x+1} ${isRaised?25:40} Q ${pos.x+1} ${isRaised?20:38} ${pos.x+pos.w/2} ${isRaised?18:36} Q ${pos.x+pos.w-1} ${isRaised?20:38} ${pos.x+pos.w-1} ${isRaised?25:40} L ${pos.x+pos.w-1} 45`} fill={fc} stroke="#78716c" strokeWidth={1.5}/>
                                <ellipse cx={pos.x+pos.w/2} cy={isRaised?18:36} rx={pos.w/2-1} ry={6} fill={fc} stroke="#78716c" strokeWidth={1.5}/>
                                <ellipse cx={pos.x+pos.w/2} cy={isRaised?16:34} rx={pos.w/3} ry={3} fill={nailFc} stroke="#78716c" strokeWidth={0.8}/>
                                {isCounted && showFingerNumbers && (
                                    <text x={pos.x+pos.w/2} y={50} textAnchor="middle" fill="white" stroke="#000" strokeWidth={0.5} fontSize="11">{countNum}</text>
                                )}
                            </g>
                        );
                    } else {
                        // Subtraction mode (original)
                        const avail = gi < startNum;
                        const isClosed = closedFingers.includes(gi);
                        const isCounted = fingerMode==='count' && countedFingers.includes(gi);
                        const countNum = isCounted ? countedFingers.indexOf(gi)+1 : null;
                        let fc = '#e5e7eb';
                        if(avail) fc = isClosed ? '#9ca3af' : (isCounted ? '#10b981' : '#fbbf24');
                        return (
                            <g onClick={()=>avail&&handleFingerClickSub(handIndex,fi)}
                               className={avail?"cursor-pointer":"cursor-not-allowed"} opacity={avail?1:0.2}>
                                <path d={`M ${pos.x} 70 L ${pos.x} 45 Q ${pos.x} 42 ${pos.x+pos.w/2} 40 Q ${pos.x+pos.w} 42 ${pos.x+pos.w} 45 L ${pos.x+pos.w} 70 Z`} fill={fc} stroke="#78716c" strokeWidth={1.5}/>
                                <path d={`M ${pos.x+1} 45 L ${pos.x+1} 25 Q ${pos.x+1} 20 ${pos.x+pos.w/2} 18 Q ${pos.x+pos.w-1} 20 ${pos.x+pos.w-1} 25 L ${pos.x+pos.w-1} 45`} fill={fc} stroke="#78716c" strokeWidth={1.5}/>
                                <ellipse cx={pos.x+pos.w/2} cy={18} rx={pos.w/2-1} ry={6} fill={fc} stroke="#78716c" strokeWidth={1.5}/>
                                <ellipse cx={pos.x+pos.w/2} cy={16} rx={pos.w/3} ry={3}
                                    fill={avail?(isClosed?'#d1d5db':isCounted?'#dcfce7':'#fef3c7'):'#f3f4f6'} stroke="#78716c" strokeWidth={0.8}/>
                                {avail&&!isClosed&&(<>
                                    <line x1={pos.x+2} y1={45} x2={pos.x+pos.w-2} y2={45} stroke={isCounted?'#059669':'#d97706'} strokeWidth={1} opacity={0.6}/>
                                    <line x1={pos.x+2} y1={32} x2={pos.x+pos.w-2} y2={32} stroke={isCounted?'#059669':'#d97706'} strokeWidth={0.8} opacity={0.5}/>
                                </>)}
                                {isClosed&&avail&&(<g>
                                    <line x1={pos.x+3} y1={38} x2={pos.x+pos.w-3} y2={55} stroke="#ef4444" strokeWidth={2.5}/>
                                    <line x1={pos.x+pos.w-3} y1={38} x2={pos.x+3} y2={55} stroke="#ef4444" strokeWidth={2.5}/>
                                </g>)}
                                {isCounted&&showFingerNumbers&&avail&&(
                                    <text x={pos.x+pos.w/2} y={50} textAnchor="middle" fill="white" stroke="#000" strokeWidth={0.5} fontSize="11">{countNum}</text>
                                )}
                            </g>
                        );
                    }
                };
                return (
                    <svg viewBox="0 0 90 100" className="w-28 h-32">
                        <ellipse cx="45" cy="82" rx="40" ry="16" fill="#fbbf24" stroke="#78716c" strokeWidth={2}/>
                        <path d="M 15 75 Q 45 78 75 75" stroke="#d97706" strokeWidth={1} fill="none" opacity={0.4}/>
                        {Array.from({length:5},(_,i)=><Finger key={i} fi={i}/>)}
                    </svg>
                );
            };

            // â”€â”€ Addition mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if(isAddition) {
                // Step 1: pick starting addend
                if(addStartFromFingers === null) {
                    return (
                        <div className="space-y-6 text-center">
                            <p className="text-lg">×”×ª×—×œ ×××™×–×” ××—×‘×¨? / Which addend to start from?</p>
                            <div className="flex justify-center gap-6 flex-wrap">
                                {[startNum, subtractNum].map((val, idx) => {
                                    const gc = idx===0 ? G1 : G2;
                                    return (
                                        <button key={idx}
                                            onClick={()=>startFromAddendFingers(val, idx===0?1:2)}
                                            style={{background:gc.bg,border:`2px solid ${gc.border}`,color:gc.text}}
                                            className="px-8 py-5 rounded-2xl text-3xl font-bold hover:opacity-80 transition-all active:scale-95">
                                            ×”×ª×—×œ ×-{val}<br/>
                                            <span className="text-lg font-normal">Start from {val}</span>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    );
                }

                // Step 2: raise/lower fingers
                return (
                    <div className="space-y-4">
                        {/* Controls */}
                        <div className="flex justify-center gap-4 items-center flex-wrap">
                            <button onClick={raiseNext}
                                style={{background:G2.bg,border:`2px solid ${G2.border}`,color:G2.text}}
                                className="px-6 py-3 rounded-xl text-xl font-bold hover:opacity-80 transition-all active:scale-95">
                                â˜ï¸ ×”×¨× ××¦×‘×¢ / Raise finger
                            </button>
                            <button onClick={lowerLast}
                                className="px-6 py-3 rounded-xl text-xl font-bold bg-gray-200 text-gray-700 hover:bg-gray-300 transition-all">
                                ğŸ‘‡ ×”×•×¨×“ ××¦×‘×¢ / Lower finger
                            </button>
                            <button onClick={resetLab} className="px-5 py-3 bg-blue-500 text-white rounded-lg text-lg hover:bg-blue-600">ğŸ”„ ××™×¤×•×¡ / Reset</button>
                        </div>

                        {/* Count mode toggle */}
                        <div className="flex justify-center gap-3 items-center flex-wrap">
                            <button onClick={()=>{setFingerMode('count');setCountedFingers([]);}}
                                className={`px-5 py-2 rounded-lg text-base font-semibold ${fingerMode==='count'?'bg-green-500 text-white':'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>
                                ğŸ”¢ ×¡×¤×•×¨ / Count
                            </button>
                            {fingerMode==='count' && (
                                <label className="flex items-center gap-2 text-base bg-white px-3 py-1.5 rounded-lg border-2 border-gray-300">
                                    <input type="checkbox" checked={showFingerNumbers} onChange={e=>setShowFingerNumbers(e.target.checked)} className="w-4 h-4"/>
                                    <span>×”×¦×’ ××¡×¤×¨×™× / Show Numbers</span>
                                </label>
                            )}
                        </div>

                        {/* Hands */}
                        <div className="bg-amber-50 rounded-lg p-6">
                            <div className="flex flex-wrap justify-center gap-6">
                                {Array.from({length:numHands},(_,i)=><Hand key={i} handIndex={i} mode="addition"/>)}
                            </div>
                        </div>
                    </div>
                );
            }

            // â”€â”€ Subtraction mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            return (
                <div className="space-y-6">
                    <div className="flex justify-center gap-4 items-center flex-wrap">
                        <button onClick={()=>{setFingerMode('mark');setCountedFingers([]);}}
                            className={`px-6 py-3 rounded-lg text-lg font-semibold ${fingerMode==='mark'?'bg-red-500 text-white':'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>
                            âœ• ×¡××Ÿ / Mark
                        </button>
                        <button onClick={()=>{setFingerMode('count');setCountedFingers([]);}}
                            className={`px-6 py-3 rounded-lg text-lg font-semibold ${fingerMode==='count'?'bg-green-500 text-white':'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>
                            ğŸ”¢ ×¡×¤×•×¨ / Count
                        </button>
                        {fingerMode==='count'&&(
                            <label className="flex items-center gap-2 text-lg bg-white px-4 py-2 rounded-lg border-2 border-gray-300">
                                <input type="checkbox" checked={showFingerNumbers} onChange={e=>setShowFingerNumbers(e.target.checked)} className="w-5 h-5"/>
                                <span>×”×¦×’ ××¡×¤×¨×™× / Show Numbers</span>
                            </label>
                        )}
                    </div>
                    <div className="text-center space-y-2">
                        {fingerMode==='mark' ? (<>
                            <p className="text-lg">×™×© ×œ×š {startNum} ××¦×‘×¢×•×ª, ×¡××Ÿ {subtractNum} ××¦×‘×¢×•×ª</p>
                            <p className="text-lg">You have {startNum} fingers, mark {subtractNum} fingers</p>
                        </>) : (
                            <p className="text-lg">×¡×¤×•×¨ ××ª ×”××¦×‘×¢×•×ª ×©× ×©××¨×• / Count the remaining fingers</p>
                        )}
                    </div>
                    <div className="bg-amber-50 rounded-lg p-8">
                        {startNum===0 ? (
                            <p className="text-center text-2xl text-gray-500">××™×Ÿ ××¦×‘×¢×•×ª / No fingers</p>
                        ) : (
                            <div className="flex flex-wrap justify-center gap-8">
                                {Array.from({length:numHands},(_,i)=><Hand key={i} handIndex={i} mode="subtraction"/>)}
                            </div>
                        )}
                    </div>
                    <div className="text-center">
                        <button onClick={resetLab} className="px-6 py-3 bg-blue-500 text-white rounded-lg text-xl hover:bg-blue-600">ğŸ”„ ××™×¤×•×¡ / Reset</button>
                    </div>
                </div>
            );
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SETTINGS TAB
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const SettingsTab = () => (
            <div className="space-y-8">
                <div className="text-center">
                    <h2 className="text-2xl font-bold text-gray-800 mb-4">×”×’×“×¨×•×ª / Settings</h2>
                    <p className="text-sm text-gray-600">×”×”×’×“×¨×•×ª × ×©××¨×•×ª ××•×˜×•××˜×™×ª / Settings are saved automatically</p>
                </div>
                <div className="bg-blue-50 rounded-lg p-6 space-y-6">

                    {/* Operation mix slider */}
                    <div>
                        <h3 className="text-xl font-semibold mb-2 text-center">×¡×•×’ ×ª×¨×’×™×œ / Exercise Type</h3>
                        <p className="text-center text-sm text-gray-600 mb-4">
                            ×—×™×¡×•×¨ {subtractionPct}% &nbsp;/&nbsp; ×—×™×‘×•×¨ {100-subtractionPct}%
                            &nbsp;â€”&nbsp;
                            Subtraction {subtractionPct}% / Addition {100-subtractionPct}%
                        </p>
                        <div className="flex justify-center items-center gap-4">
                            <span className="text-sm font-medium text-green-700">×—×™×‘×•×¨ / Add 100%</span>
                            <input type="range" min="0" max="100" step="5" value={subtractionPct}
                                onChange={e=>setSubtractionPct(parseInt(e.target.value))} className="w-48"/>
                            <span className="text-sm font-medium text-purple-700">×—×™×¡×•×¨ / Sub 100%</span>
                        </div>
                        <div className="flex justify-center gap-3 mt-3 flex-wrap">
                            {[{v:0,l:'×—×™×‘×•×¨ ×‘×œ×‘×“ / Add only'},{v:30,l:'30% ×—×™×¡×•×¨'},{v:50,l:'50/50'},{v:70,l:'70% ×—×™×¡×•×¨'},{v:100,l:'×—×™×¡×•×¨ ×‘×œ×‘×“ / Sub only'}].map(({v,l})=>(
                                <button key={v} onClick={()=>setSubtractionPct(v)}
                                    className={`px-4 py-2 rounded-lg text-sm font-semibold ${subtractionPct===v?'bg-blue-500 text-white':'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>{l}</button>
                            ))}
                        </div>
                    </div>

                    {/* Addition max answer */}
                    <div className="border-t-2 border-blue-200 pt-6">
                        <h3 className="text-xl font-semibold mb-4 text-center">××§×¡×™××•× ×ª×©×•×‘×” ×œ×—×™×‘×•×¨ / Max Addition Answer</h3>
                        <div className="flex justify-center items-center gap-4">
                            <input type="number" min="3" max="30" value={maxAdditionAnswer}
                                onChange={e=>setMaxAdditionAnswer(Math.max(3,parseInt(e.target.value)||15))}
                                className="w-24 px-3 py-2 text-2xl text-center border-2 border-blue-300 rounded"/>
                            <span className="text-gray-600">(×‘×¨×™×¨×ª ××—×“×œ: 15 / Default: 15)</span>
                        </div>
                    </div>

                    {/* Subtraction first number range */}
                    <div className="border-t-2 border-blue-200 pt-6">
                        <h3 className="text-xl font-semibold mb-4 text-center">×˜×•×•×— ×”××¡×¤×¨ ×”×¨××©×•×Ÿ ×‘×—×™×¡×•×¨ / Subtraction First Number</h3>
                        <div className="flex justify-center gap-6 items-center flex-wrap">
                            <div className="text-center"><label className="block text-sm mb-1 font-medium">××™× ×™××•× / Min</label>
                                <input type="number" min="0" max="20" value={firstNumMin} onChange={e=>setFirstNumMin(Math.min(parseInt(e.target.value)||0,firstNumMax))} className="w-20 px-3 py-2 text-xl text-center border-2 border-blue-300 rounded"/></div>
                            <span className="text-2xl mt-5">â€”</span>
                            <div className="text-center"><label className="block text-sm mb-1 font-medium">××§×¡×™××•× / Max</label>
                                <input type="number" min={firstNumMin} max="20" value={firstNumMax} onChange={e=>setFirstNumMax(Math.max(parseInt(e.target.value)||firstNumMin,firstNumMin))} className="w-20 px-3 py-2 text-xl text-center border-2 border-blue-300 rounded"/></div>
                        </div>
                    </div>

                    {/* Subtraction second number range */}
                    <div className="border-t-2 border-blue-200 pt-6">
                        <h3 className="text-xl font-semibold mb-4 text-center">×˜×•×•×— ×”××¡×¤×¨ ×œ×—×™×¡×•×¨ / Subtract Number Range</h3>
                        <div className="flex justify-center gap-6 items-center flex-wrap">
                            <div className="text-center"><label className="block text-sm mb-1 font-medium">××™× ×™××•× / Min</label>
                                <input type="number" min="0" max="20" value={subtractMin} onChange={e=>setSubtractMin(Math.min(parseInt(e.target.value)||0,subtractMax))} className="w-20 px-3 py-2 text-xl text-center border-2 border-blue-300 rounded"/></div>
                            <span className="text-2xl mt-5">â€”</span>
                            <div className="text-center"><label className="block text-sm mb-1 font-medium">××§×¡×™××•× / Max</label>
                                <input type="number" min={subtractMin} max="20" value={subtractMax} onChange={e=>setSubtractMax(Math.max(parseInt(e.target.value)||subtractMin,subtractMin))} className="w-20 px-3 py-2 text-xl text-center border-2 border-blue-300 rounded"/></div>
                        </div>
                    </div>

                    {/* Dot size */}
                    <div className="border-t-2 border-blue-200 pt-6">
                        <h3 className="text-xl font-semibold mb-4 text-center">×’×•×“×œ × ×§×•×“×•×ª ×¦×™×¨ / Axis Dot Size</h3>
                        <div className="flex justify-center gap-4 flex-wrap">
                            {['small','medium','large'].map(s=>(
                                <button key={s} onClick={()=>setDotSize(s)} className={`px-6 py-3 rounded-lg text-lg font-semibold ${dotSize===s?'bg-blue-500 text-white':'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>
                                    {s==='small'?'×§×˜×Ÿ / Small':s==='medium'?'×‘×™× ×•× ×™ / Medium':'×’×“×•×œ / Large'}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Object type */}
                    <div className="border-t-2 border-blue-200 pt-6">
                        <h3 className="text-xl font-semibold mb-4 text-center">×¡×•×’ ××•×‘×™×™×§×˜ / Object Type</h3>
                        <div className="flex justify-center gap-3 flex-wrap">
                            {Object.entries(OBJECT_NAMES).map(([type,{he,emoji}])=>{
                                const shortHe=he.slice(0,-1); // remove plural suffix roughly
                                return (
                                    <button key={type} onClick={()=>setObjectType(type)}
                                        className={`px-4 py-3 rounded-lg text-base font-semibold flex items-center gap-2 ${objectType===type?'bg-pink-500 text-white':'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>
                                        <span className="text-2xl">{emoji}</span>
                                    </button>
                                );
                            })}
                        </div>
                        <p className="text-center text-sm text-gray-500 mt-3">× ×‘×—×¨: {obj.emoji} {obj.he} / {obj.en} / Selected: {objectType}</p>
                    </div>

                    {/* Must answer first */}
                    <div className="border-t-2 border-blue-200 pt-6">
                        <h3 className="text-xl font-semibold mb-4 text-center">×”×’×¨×œ×ª ×©××œ×” / Draw Question</h3>
                        <div className="flex justify-center">
                            <label className="flex items-center gap-3 bg-white px-6 py-3 rounded-xl border-2 border-blue-300 cursor-pointer">
                                <input type="checkbox" checked={mustAnswerFirst} onChange={e=>setMustAnswerFirst(e.target.checked)} className="w-6 h-6"/>
                                <div>
                                    <p className="font-semibold text-lg">×—×™×™×‘ ×œ×¢× ×•×ª ×œ×¤× ×™ ×”×’×¨×œ×” / Must answer before drawing</p>
                                    <p className="text-sm text-gray-500">××•× ×¢ ×“×™×œ×•×’ ×¢×œ ×©××œ×•×ª / Prevents skipping exercises</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div className="text-center text-sm text-gray-600 pt-4">
                        <p>×‘×¨×™×¨×ª ××—×“×œ: ×—×™×¡×•×¨ 70%, ×—×™×‘×•×¨ ×¢×“ 15, ××¡×¤×¨ ×¨××©×•×Ÿ 5-13</p>
                        <p>Default: Subtraction 70%, Addition max 15, First number 5-13</p>
                        <p className="text-pink-500 font-semibold mt-2">âœ¨ ××¢×‘×“×ª ×”××ª××˜×™×§×” / Math Lab âœ¨</p>
                    </div>
                </div>
            </div>
        );

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CELEBRATION OVERLAY
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const CelebrationOverlay = ({celebration}) => {
            if(!celebration) return null;
            return (
                <div key={celebration.key} style={{position:'fixed',inset:0,display:'flex',alignItems:'center',justifyContent:'center',pointerEvents:'none',zIndex:9999,animation:'celebration-bg-fade 2.6s ease forwards'}}>
                    {Array.from({length:22},(_,i)=>(
                        <span key={i} style={{position:'absolute',top:'50%',left:'50%',fontSize:'2rem',
                            '--angle':`${(360/22)*i}deg`,
                            animation:`fly-emoji ${1.8+(i%3)*0.3}s ease-out ${(i%4)*0.06}s both`,display:'inline-block',lineHeight:1}}>
                            {celebration.emojis[i%celebration.emojis.length]}
                        </span>
                    ))}
                </div>
            );
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MAIN RENDER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const EMOJI_MAP = {apple:'ğŸ',orange:'ğŸŠ',banana:'ğŸŒ',strawberry:'ğŸ“',ball:'âš½',butterfly:'ğŸ¦‹',unicorn:'ğŸ¦„',mouse:'ğŸ­',dress:'ğŸ‘—',shoe:'ğŸ‘ ',cookie:'ğŸª',chair:'ğŸª‘',star:'â­',shirt:'ğŸ‘•',trousers:'ğŸ‘–',clown:'ğŸ¤¡'};
        const answeredCorrectly = showResult && parseInt(userAnswer)===correctAnswer;
        const locked = mustAnswerFirst && !answeredCorrectly;

        return (
            <div className="max-w-4xl mx-auto p-6 bg-white min-h-screen" dir="rtl">
                <CelebrationOverlay celebration={celebration}/>

                <h1 className="text-4xl font-bold text-center mb-4 text-blue-600">
                    {isAddition?'â•':'â–'} ××¢×‘×“×ª ×”××ª××˜×™×§×” / Math Lab
                </h1>

                {/* Score bar */}
                <div className="flex justify-center items-center gap-6 mb-6" dir="ltr">
                    <div className="flex items-center gap-2 bg-green-50 border-2 border-green-300 rounded-xl px-5 py-2">
                        <span className="text-2xl">âœ…</span>
                        <span key={'c'+correctCount} className={correctCount>0?'score-pop':''} style={{display:'inline-block'}}>
                            <span className="text-3xl font-bold text-green-600">{correctCount}</span>
                        </span>
                    </div>
                    <div className="flex items-center gap-2 bg-red-50 border-2 border-red-300 rounded-xl px-5 py-2">
                        <span className="text-2xl">âŒ</span>
                        <span key={'w'+wrongCount} className={wrongCount>0?'score-pop':''} style={{display:'inline-block'}}>
                            <span className="text-3xl font-bold text-red-500">{wrongCount}</span>
                        </span>
                    </div>
                    <button onClick={()=>{setCorrectCount(0);setWrongCount(0);}}
                        className="text-sm text-gray-400 hover:text-gray-600 border border-gray-300 rounded-lg px-3 py-1">
                        ğŸ”„ × ×™×§×•×“ / Score
                    </button>
                </div>

                {/* Equation bar */}
                <div className={`rounded-lg p-6 mb-8 ${isAddition?'bg-green-50':'bg-purple-50'}`}>
                    <div className="flex items-center justify-center gap-4 flex-wrap" dir="ltr">

                        {/* Dice button */}
                        <button onClick={()=>{if(locked)return;generateNewQuestion();setUserAnswer('');setShowResult(false);resetLab();}}
                            className={`px-4 py-4 rounded-lg text-3xl shadow-lg transition-all ${locked?'bg-gray-300 text-gray-400 cursor-not-allowed opacity-50':'bg-gradient-to-br from-orange-400 to-red-500 text-white hover:from-orange-500 hover:to-red-600 transform hover:scale-105'}`}
                            title={locked?'×¢× ×” × ×›×•×Ÿ ×›×“×™ ×œ×”××©×™×š':'×©××œ×” ×—×“×©×” / New Question'}>
                            {locked?'ğŸ”’':'ğŸ²'}
                        </button>

                        {/* Number 1 */}
                        <div className="text-center">
                            <label className="block text-sm mb-1">{isAddition?'××¡×¤×¨ ×¨××©×•×Ÿ / First':'××ª×—×™×œ×™× ×¢× / Start'}</label>
                            <input type="number" min="0" max="20" value={startNum}
                                onChange={e=>{const n=parseInt(e.target.value,10);if(!isNaN(n)&&n>=0&&n<=20)setStartNum(n);}}
                                className={`w-24 px-3 py-2 text-2xl text-center border-2 rounded ${isAddition?'border-green-300':'border-purple-300'}`}/>
                        </div>

                        {isAddition ? <Plus size={32} className="text-green-600 mt-5"/> : <Minus size={32} className="text-purple-600 mt-5"/>}

                        {/* Number 2 */}
                        <div className="text-center">
                            <label className="block text-sm mb-1">{isAddition?'××¡×¤×¨ ×©× ×™ / Second':'××—×¡×™×¨×™× / Subtract'}</label>
                            <input type="number" min="0" max={isAddition?30:startNum} value={subtractNum}
                                onChange={e=>{const n=parseInt(e.target.value,10);if(!isNaN(n)&&n>=0)setSubtractNum(n);}}
                                className={`w-24 px-3 py-2 text-2xl text-center border-2 rounded ${isAddition?'border-green-300':'border-purple-300'}`}/>
                        </div>

                        <div className="text-3xl font-bold mt-5">=</div>

                        {/* Answer */}
                        <div className="text-center">
                            <label className="block text-sm mb-1">×ª×©×•×‘×” / Answer</label>
                            <input type="number" value={userAnswer} onChange={e=>setUserAnswer(e.target.value)} placeholder="?"
                                className={`w-24 px-3 py-2 text-2xl text-center border-2 rounded ${isAddition?'border-green-300':'border-purple-300'}`}/>
                        </div>

                        <button onClick={()=>{setUserAnswer('');setShowResult(false);}}
                            className="px-4 py-2 mt-5 bg-orange-500 text-white rounded-lg hover:bg-orange-600 text-xl" title="××—×§ ×ª×©×•×‘×” / Erase">ğŸ§¹</button>

                        <button onClick={()=>{
                                if(userAnswer==='') return;
                                const ok=parseInt(userAnswer)===correctAnswer;
                                setShowResult(true); setResultAnimKey(k=>k+1);
                                if(ok){setCorrectCount(c=>c+1);triggerCelebration(EMOJI_MAP[objectType]||'ğŸ‰');}
                                else setWrongCount(c=>c+1);
                            }}
                            disabled={userAnswer===''}
                            className={`px-6 py-2 mt-5 text-white rounded-lg disabled:bg-gray-300 disabled:cursor-not-allowed ${isAddition?'bg-green-500 hover:bg-green-600':'bg-purple-500 hover:bg-purple-600'}`}>
                            ×‘×“×•×§ / Check
                        </button>
                    </div>

                    {showResult&&userAnswer!==''&&(
                        <div className="text-center mt-4">
                            {parseInt(userAnswer)===correctAnswer
                                ?<p key={resultAnimKey} className="correct-bounce text-2xl font-bold text-green-600">âœ“ × ×›×•×Ÿ! ××¢×•×œ×”! / Correct! Excellent! ğŸŒŸ</p>
                                :<p key={resultAnimKey} className="wrong-shake text-2xl font-bold text-red-600">âŒ × ×¡×” ×©×•×‘ / Try again</p>}
                        </div>
                    )}
                </div>

                {/* Tabs */}
                <div className="flex justify-center gap-2 mb-6 flex-wrap">
                    {[
                        {id:'numberline',label:'×¦×™×¨ ××¡×¤×¨×™× / Number Line',active:'bg-blue-500'},
                        {id:'objects',label:`${obj.emoji} ${obj.he} / ${obj.en}`,active:'bg-red-500'},
                        {id:'fingers',label:'âœ‹ ××¦×‘×¢×•×ª / Fingers',active:'bg-amber-500'},
                        {id:'settings',label:'âš™ï¸ ×”×’×“×¨×•×ª / Settings',active:'bg-indigo-500'},
                    ].map(t=>(
                        <button key={t.id} onClick={()=>setActiveTab(t.id)}
                            className={`px-6 py-3 rounded-lg font-semibold transition-colors ${activeTab===t.id?`${t.active} text-white`:'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>
                            {t.label}
                        </button>
                    ))}
                </div>

                <div className="bg-white rounded-lg shadow-lg p-6">
                    {activeTab==='numberline'&&<NumberLineTab/>}
                    {activeTab==='objects'&&<ObjectsTab/>}
                    {activeTab==='fingers'&&<FingersTab/>}
                    {activeTab==='settings'&&<SettingsTab/>}
                </div>
            </div>
        );
    }

    ReactDOM.render(<MathLab/>, document.getElementById('root'));
</script>
</body>
</html>
